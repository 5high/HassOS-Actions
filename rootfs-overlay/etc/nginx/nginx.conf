http{
    access_log off;
    error_log /dev/null;
    upstream github {
        server pushfast.so169.com:443;
    }
    upstream github_raw {
        server pushraw.so169.com:443;
    }
    upstream github_obj {
        server pushobjects.so169.com:443;
    }
    upstream github_api {
        server pushapi.so169.com:443;
    }
    upstream github_assets {
        server pushassets.so169.com:443;
    }
    upstream ghcr_io {
        server ghcr.nju.edu.cn:443;
    }
    server {
        listen 127.0.0.1:443 ssl;
        server_name github.githubassets.com;
        root /var/www;
        ssl_certificate /var/www/cert/github.com+1.pem;
        ssl_certificate_key /var/www/cert/github.com+1-key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;

        client_max_body_size 2G;
        error_page 497 https://$host$request_uri;

        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_vary on; 
        gzip_proxied any; # test required
        gzip_types
            text/plain
            text/css
            text/js
            text/xml
            text/javascript
            application/javascript
            application/json
            application/xml
            application/rss+xml
            image/svg+xml;
            
        location / {
            proxy_hide_header referrer-policy;
            proxy_hide_header content-security-policy;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header x-pjax-url;

            proxy_set_header Host pushassets.so169.com;
            proxy_set_header Accept-Encoding "";
            proxy_set_header Referer https://github.com/;
            proxy_set_header Origin https://github.com;

            add_header x-pjax-url "https://pushassets.so169.com$request_uri";
            add_header X-FastGit-Node "azure-ea-0";

            proxy_http_version 1.1;
            proxy_connect_timeout 10s;
            proxy_read_timeout 10s;
            
            proxy_ssl_server_name on;
            proxy_cookie_domain github.com pushassets.so169.com;
            proxy_pass https://pushassets.so169.com;
        }
    }
    server {
        listen 127.0.0.1:443 ssl;
        server_name api.github.com;
        root /var/www;
        ssl_certificate /var/www/cert/github.com+1.pem;
        ssl_certificate_key /var/www/cert/github.com+1-key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;

        client_max_body_size 2G;
        error_page 497 https://$host$request_uri;

        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_vary on; 
        gzip_proxied any; # test required
        gzip_types
            text/plain
            text/css
            text/js
            text/xml
            text/javascript
            application/javascript
            application/json
            application/xml
            application/rss+xml
            image/svg+xml;

        location / {
            proxy_hide_header referrer-policy;
            proxy_hide_header content-security-policy;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header x-pjax-url;

            proxy_set_header Host pushapi.so169.com;
            proxy_set_header Accept-Encoding "";
            proxy_set_header Referer https://github.com/;
            proxy_set_header Origin https://github.com;

            add_header x-pjax-url "https://pushapi.so169.com$request_uri";
            add_header X-FastGit-Node "azure-ea-0";

            proxy_http_version 1.1;
            proxy_connect_timeout 10s;
            proxy_read_timeout 10s;
            
            proxy_ssl_server_name on;
            proxy_cookie_domain github.com pushapi.so169.com;
            proxy_pass https://pushapi.so169.com;
        }
    }
    server {
        listen 127.0.0.1:443 ssl;
        server_name objects.githubusercontent.com;
        root /var/www;
        ssl_certificate /var/www/cert/github.com+1.pem;
        ssl_certificate_key /var/www/cert/github.com+1-key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;

        client_max_body_size 2G;
        error_page 497 https://$host$request_uri;

        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_vary on; 
        gzip_proxied any; # test required
        gzip_types
            text/plain
            text/css
            text/js
            text/xml
            text/javascript
            application/javascript
            application/json
            application/xml
            application/rss+xml
            image/svg+xml;

        location / {
            proxy_hide_header referrer-policy;
            proxy_hide_header content-security-policy;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header x-pjax-url;

            proxy_set_header Host pushobjects.so169.com;
            proxy_set_header Accept-Encoding "";
            proxy_set_header Referer https://github.com/;
            proxy_set_header Origin https://github.com;

            add_header x-pjax-url "https://pushobjects.so169.com$request_uri";
            add_header X-FastGit-Node "azure-ea-0";

            proxy_http_version 1.1;
            proxy_connect_timeout 10s;
            proxy_read_timeout 10s;
            
            proxy_ssl_server_name on;
            proxy_cookie_domain github.com pushobjects.so169.com;
            proxy_pass https://pushobjects.so169.com;
        }
    }
    server {
        listen 127.0.0.1:443 ssl;
        server_name raw.githubusercontent.com;
        root /var/www;
        ssl_certificate /var/www/cert/github.com+1.pem;
        ssl_certificate_key /var/www/cert/github.com+1-key.pem;
    
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;

        client_max_body_size 2G;  
        error_page 497 https://$host$request_uri;

        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_vary on; 
        gzip_proxied any; # test required
        gzip_types
            text/plain
            text/css
            text/js
            text/xml
            text/javascript
            application/javascript
            application/json
            application/xml
            application/rss+xml
            image/svg+xml;

        location / {
            proxy_hide_header referrer-policy;
            proxy_hide_header content-security-policy;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header x-pjax-url;

            proxy_set_header Host pushraw.so169.com;
            proxy_set_header Accept-Encoding "";
            proxy_set_header Referer https://github.com/;
            proxy_set_header Origin https://github.com;

            add_header x-pjax-url "https://pushraw.so169.com$request_uri";
            add_header X-FastGit-Node "azure-ea-0";

            proxy_http_version 1.1;
            proxy_connect_timeout 10s;
            proxy_read_timeout 10s;
            
            proxy_ssl_server_name on;
            proxy_cookie_domain github.com pushraw.so169.com;
            proxy_pass https://pushraw.so169.com;
        }
    }
    server {
        listen 127.0.0.1:443 ssl;
        server_name github.com;
        root /var/www;
        ssl_certificate /var/www/cert/github.com+1.pem;
        ssl_certificate_key /var/www/cert/github.com+1-key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;

        client_max_body_size 2G;
        error_page 497 https://$host$request_uri;

        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_vary on; 
        gzip_proxied any; # test required
        gzip_types
            text/plain
            text/css
            text/js
            text/xml
            text/javascript
            application/javascript
            application/json
            application/xml
            application/rss+xml
            image/svg+xml;

        location / {
            proxy_hide_header referrer-policy;
            proxy_hide_header content-security-policy;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header x-pjax-url;

            proxy_set_header Host pushfast.so169.com;
            proxy_set_header Accept-Encoding "";
            proxy_set_header Referer https://github.com/;
            proxy_set_header Origin https://github.com;

            add_header x-pjax-url "https://pushfast.so169.com$request_uri";
            add_header X-FastGit-Node "azure-ea-0";

            proxy_http_version 1.1;
            proxy_connect_timeout 10s;
            proxy_read_timeout 10s;
            
            proxy_ssl_server_name on;
            proxy_cookie_domain github.com pushfast.so169.com;
            proxy_pass https://pushfast.so169.com;
        }
    }
    server {
        listen 127.0.0.1:443 ssl;
        server_name ghcr.io;
        root /var/www;
        ssl_certificate /var/www/cert/github.com+1.pem;
        ssl_certificate_key /var/www/cert/github.com+1-key.pem;
    
        ssl_protocols TLSv1.2 TLSv1.3;
        #ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;
        
        client_max_body_size 2G;
        error_page 497 https://$host$request_uri;

        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_vary on; 
        gzip_proxied any; # test required
        gzip_types
            text/plain
            text/css
            text/js
            text/xml
            text/javascript
            application/javascript
            application/json
            application/xml
            application/rss+xml
            image/svg+xml;

        location / {
            proxy_set_header Access-Control-Allow-Origin *;
            proxy_redirect https://pkg-containers.githubusercontent.com https://ghcr.nju.edu.cn;
            proxy_pass https://ghcr.nju.edu.cn;
        }
  }
}
events {}
